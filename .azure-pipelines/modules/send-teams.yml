## ===========================
## templates/send-teams.yml  
## ===========================
steps:
  - task: PowerShell@2
    displayName: 'üì£ Notifying Teams'
    env:
      GMAIL_PASS: "$(GMAIL_PASS)"
    name: SetVarTeams
    inputs:
      targetType: 'inline'
      script: |
        try {
          $webhookUrl = "$(WEBHOOK_TEAMS)"
          
          $fileLink = "$(UploadToOneDrive.1DriveLink)"
          # Write-Host "Value of 1 Drive Link= $fileLink"

          $artLink = "$(SetValues.artifactLink)"         
          # Write-Host "Value of artifact Link= $artLink"

          if (-not $fileLink) {
            Write-Error "‚ùå OneDrive link not found."
            exit 1
          }         
          $fullInfo="$(infoFeatures)"
          # Write-Host "üîç raw:`n$fullInfo"
         
          $fullContent="$(newFeatures)"
          # Write-Host "üîç raw:`n$fullContent"

          $fullInfo = $fullInfo -replace "\[\[NEWLINE\]\]", "`n"
          $fullInfo = $fullInfo -replace "`r`n", "`n"         
        
          $fullInfo = ($fullInfo -split "`n" | ForEach-Object {
             $_ -replace '^\s*#{1,2}\s*', ''  
          }) -join "`n"

          $fullInfo = $fullInfo -replace "`n", "`n`n"    

          $fullContent = $fullContent -replace "\[\[NEWLINE\]\]", "`n"
          $fullContent = $fullContent -replace "`r`n", "`n"    
          # $fullContent = ($fullContent -split "`n" | ForEach-Object {
          #    $_ -replace '^\s*#{1,2}\s*', ''  
          # }) -join "`n"
          $fullContent = ($fullContent -replace "`n", "`n`n") -join "`n"    

          #Write-Host "‚úÖ processed:`n$fullContent"
         
          if (-not $fullContent.Trim()) {
            Write-Error "‚ùå fullContent is empty."
            exit 1
          }     

          $card = @{
            type = "message"
            serviceUrl = "http://localhost:60642"
            channelId = "emulator"
                from = @{
                    id = $fromId
                    name = "TestUser"
                }
                recipient = @{
                    id = $recipientId
                    name = "TestBot"
                }
                conversation = @{
                    id = $conversationId
                }
                text = "Message with Adaptive Card"
                attachments = @(
                    @{
                        contentType = "application/vnd.microsoft.card.adaptive"
                        content = @{
                            "$schema" = "http://adaptivecards.io/schemas/adaptive-card.json"
                            type = "AdaptiveCard"
                            version = "1.5"
                            body = @(
                                @{
                                    type = "TextBlock"
                                    text = "üëã Hi team!"
                                    weight = "Bolder"
                                    size = "Medium"
                                },
                                @{
                                    type = "TextBlock"
                                    text = "$(Title_1_Teams)"
                                    wrap = $true
                                },
                                @{
                                    type = "TextBlock"
                                    text = "[üîó Click here to see the Repo]($artLink)"
                                    wrap = $true
                                },
                                @{
                                    type = "TextBlock"
                                    text = "&nbsp;"
                                    wrap = $true
                                },
                                @{
                                    type = "TextBlock"
                                    text = $fullInfo
                                    wrap = $true
                                    isSubtle = $true
                                },
                                @{
                                    type = "TextBlock"
                                    text = "&nbsp;"
                                    wrap = $true
                                },
                                @{
                                    type = "TextBlock"
                                    text = $fullContent
                                    wrap = $true
                                    isSubtle = $true
                                },
                                @{
                                    type = "Container"
                                    horizontalAlignment = "Right"
                                    items = @(
                                        @{
                                            type = "ActionSet"
                                            actions = @(
                                                @{
                                                    type  = "Action.OpenUrl"
                                                    title = "Download Installer üì•"
                                                    url   = $fileLink
                                                }
                                            )
                                        }
                                    )
                                }
                            )  
                        }
                    }
                 )

             } #End card
           $json = $card | ConvertTo-Json -Depth 10 -Compress
           $bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
           Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $bytes -ContentType 'application/json'  
           Write-Host "‚ú® Message sent to Teams group."
         }       
         catch {
           Write-Host "‚ö†Ô∏è Teams notification failed, sending email to manager..."

           $link = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts&type=publishedArtifacts"

           $body = @"
        <html>
        <body>
        <p>Hello team,</p>

        <p>The DataView2 release has been deployed successfully, but the Teams notification failed.</p>

        <p>Please verify the deployment manually at:<br/>
        <a href='$link'>$link</a></p>

        <p>Regards.</p>
        </body>
        </html>
        "@

           & "$(Build.SourcesDirectory)\$(PCKG_NAME)\.scripts\Send-Email.ps1" `
             -emailFrom "$(EMAIL_FROM)" `
             -emailTo "$(EMAIL_MANAGER)" `
             -smtpServer "smtp.gmail.com" `
             -smtpPort "587" `
             -emailSubject "üö® Teams notification failed (DataView2 release)" `
             -smtpUser "$(EMAIL_FROM)" `
             -emailBody $body `
             -isBodyHtml $true  
          
         }

 


                