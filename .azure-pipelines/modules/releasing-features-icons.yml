## ==========================
## templates/releasing-features.yml
## ==========================
steps: 
  - task: PowerShell@2
    displayName: 'ğŸ“„ Generate release-features.md from pipe_settings.json'   
    inputs:
      targetType: 'inline'
      script: |
        $repoRoot = "$(Build.SourcesDirectory)"
        # $settingsPath = Join-Path $repoRoot "$(packageName)\pipe_settings.json"
        $settings_Path = "$(settingsPath)"
        # $releaseNotesPath = Join-Path $repoRoot "Source\.docs\release-features.md"
        $releaseNotesPath = Join-Path $repoRoot "\release-features.md"

        # Write-Host ">>>> Settings.json Path:   $settings_Path"
        $settingsRaw = Get-Content $settings_Path -Raw
        # Write-Host ">>>> ğŸ§¾ settings.json row content:"
        # Write-Host "$settingsRaw"


        if (!(Test-Path $settings_Path)) {
          Write-Host "âŒ pipe_settings.json not found at $settings_Path"
          return
        }

        # Write-Host "ğŸ§¾ JSON read from ${settings_Path}:"
        # Get-Content $settings_Path -Raw | Write-Host

        # Reading pipe_settings.json  
        $json = Get-Content $settings_Path -Raw | ConvertFrom-Json
        $features = $json.'features-release-icons'
        $iconFlag = $json.Icon

        if (-not $features -or $features.Count -eq 0) {
          Write-Error "âŒ No 'features-release-icons' found in pipe_settings.json"
          return
        }

        # Map type â†’ icon
        if ($iconFlag -eq 1) { 
        $iconMap = @{
          "Feature" = "ğŸ†•"
          "Bug" = "ğŸ› ï¸"
          "Change" = "âœï¸"
          "Improvement" = "ğŸ”§" 
          "Remove" = "âŒ"
          "Item" = "ğŸ”¹"
          }
         } else {
            # Icon = 0 â†’ Using always the same icon
            $iconMap = @{
              "Feature" = "ğŸ”¹"
              "Bug" = "ğŸ”¹"
              "Change" = "ğŸ”¹"
              "Improvement" = "ğŸ”¹"
              "Remove" = "ğŸ”¹"
              "Item" = "ğŸ”¹"
            }
         }

        # Header
        $version = "v.$(fixedBuildVersion)"
        $publicationDate = Get-Date -Format "yyyy-MM-dd"
        $header = "#âœ¨ Release $version - Highlighted Features`r`n" +
                  "##ğŸ—“ Release date: $publicationDate`r`n"  +
                  "`r`n"
                  

        # Body
        $body = "$(Title_2_Teams) `r`n `r`n"
        for ($i = 0; $i -lt $features.Count; $i++) {
          $type = $features[$i].type
          $desc = $features[$i].description
          $icon = $iconMap[$type] 
          if (-not $icon) { $icon = "ğŸ”¹" }  # Fallback
          $body += "$icon $desc`r`n"
        }

        $fullContent = $header + "`r`n" + $body        

        # Secure .docs folder
        $docsFolder = Join-Path $repoRoot ".docs"
        if (!(Test-Path $docsFolder)) {
          New-Item -ItemType Directory -Path $docsFolder | Out-Null
        }

        # Force file recreation so that Git always sees it as new.
        if (Test-Path $releaseNotesPath) {
          Remove-Item $releaseNotesPath -Force
        }

        # Save content generated
        Set-Content -Path $releaseNotesPath -Value $fullContent -Encoding UTF8

        # Escape content for the variable
        $headerEscaped = $header -replace "`r`n", "[[NEWLINE]]" -replace "`n", "[[NEWLINE]]"
        $featuresEscaped =  $body  -replace "`r`n", "[[NEWLINE]]" -replace "`n", "[[NEWLINE]]"


        $fullContent = $body
        # Write-Host "FeaturesEscaped:  $featuresEscaped"
        
        Write-Host "##vso[task.setvariable variable=infoFeatures]$headerEscaped"
        Write-Host "##vso[task.setvariable variable=newFeatures]$featuresEscaped"
        Write-Host "##vso[task.setvariable variable=releaseNotesPath]$releaseNotesPath"
        # Write-Host "ğŸ“„ Content generated:`n$fullContent"

        Write-Host "âœ… release-features.md generated successfully at: $releaseNotesPath" 

        # #Write-Host "ğŸ“„ Verifying saved file..."
        # $verificacion = Get-Content -Path $releaseNotesPath -Raw
        # Write-Host "ğŸ§¾ release-features.md contains:`n$verificacion"

  - task: PowerShell@2
    displayName: 'ğŸ” Commit & push from release-features.md using GIT_ASKPASS with PAT'
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    inputs:
      targetType: 'inline'
      script: |
        try {
            $repoRoot         = "$(Build.SourcesDirectory)"
            $repoRelPath      = ".docs\release-features.md" 
            $repoFullPath     = Join-Path $repoRoot $repoRelPath
            $releaseNotesPath = "$(releaseNotesPath)"
            if (-not (Test-Path $releaseNotesPath)) {
              Write-Host "âŒ No existe el archivo $releaseNotesPath"
              return
            }
            Write-Host "ğŸ“„ Moving from ReleaseNotesPath: $releaseNotesPath  to `nRepoFullPath: $repoFullPath"
            Copy-Item -Path $releaseNotesPath -Destination $repoFullPath -Force       

            git config user.email $(EMAIL_AUTHOR)
            git config user.name  "Azure DevOps Build Agent"

            $gitStatus = git status --porcelain
            if (-not $gitStatus) {
               Write-Host "âœ… No changes in the files to commit. Skipping commit."
               exit 0 # Exited the script successfully
            }

            Write-Host "ğŸ“¦ Changes detected. Preparing for commit."
            git status # Show changes for debugging

            # --- Add the files to Git's staging area ---
            git add $repoRelPath
            Write-Host "âœ… Files added to Git: $releaseNotesPath"

             # ---  Perform the commit ---
             # [skip ci] is VITAL to prevent this push from triggering the pipeline again.
             $commitMessage = "CI: Update release-features.md.[skip ci]"
             git commit -m $commitMessage
             Write-Host "âœ… Commit performed with message: '$commitMessage'"
 
             # --- Push the changes to the remote repository ---            
             git push origin HEAD:main
             Write-Host "ğŸš€ Push completed to the 'main' branch of the repository."        
                       
                        
        }
        catch {
          Write-Warning "âš ï¸ Error while attempting to commit/push release-features.md."
          Write-Warning "â†³ Details: $($_.Exception.Message)"
          exit 0
        }